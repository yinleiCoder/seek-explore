---
title: 后端系统业务场景设计方案
description: 由后端业务点切入，展开提出后端系统的架构设计、思路、解决方案，专注于中大型网站架构
date: '2023-12-28 14:16:16'
tag: 计算机
---

> 后端开发和网络安全的开发者会遇到的挑战一样，有很多问题，不放到一个海量用户的环境下，是难以暴露出来的。量变引起质变，管理10台服务器和管理1万台服务器的方法肯定会有所区别。  
> 画图工具：https://app.eraser.io/

## Contents

# 单体应用到微服务架构(代码奔腾Mozilla团队)

> 微服务发展最好的就是Go、Java

## 单体应用开发之痛

![单体应用架构](/images/backendSystem/单体应用.png)

以“尹氏纹眉电商系统”为例，其单体应用架构为：

![电商单体应用](/images/backendSystem/电商单体应用.png)

上图架构引发的常见问题包括：代码冲突导致的回归测试、代码屎山不敢动、环境不敢随便变动等。

同时，请看下图常见电商系统架构，其产生的实际需求是：**功能增多**、**并发增加**。

![电商单体应用初期](/images/backendSystem/电商单体应用初期.png)

这套系统运行的挺好，此时客户向我提出了一个新需求：在此基础上再开发一个电商微信小程序，提供商品秒杀功能、团购功能等。此时的架构就需要变动：

![电商微信小程序需求](/images/backendSystem/电商微信小程序需求.png)

但是仔细想一下，这样的设计合理吗：代码复用、系统间相互调用、系统既对内又对外提供API接口、数据库被多个服务依赖无法拆分升级、以表作为中介来通信、某个接口性能太差拖慢数据库、开发测试部署困难等问题。同时，若用户还要添加离线分析系统，通过数据分析以便科学决策，那么还会导致数据库性能问题进而影响正常的业务。

## 服务拆分

为了解决上述单体应用代码重复问题，架构进行如下变动：

- 代码模块化
- 服务方式管理

![电商代码复用](/images/backendSystem/电商代码复用.png)

这种架构通过代码方式将服务进行了隔离，但数据库还是进行了强相关互相影响，改表结构会产生未知影响，所以还需要进一步的隔离。

## 微服务的拆分

为了解决数据库瓶颈、消息解耦，架构还需要进一步拆分：

![电商微服务基本拆分](/images/backendSystem/电商微服务基本拆分.png)

此架构利用多台服务器来解决性能问题，引入了服务的独立性，数据库独立、代码独立。但仔细观察，还是能发现此架构存在一些问题：这些服务是暴露的端口，而用户终端设备都是发起http请求，就意味着这些服务必须支持http协议，http请求在各服务间通讯就显得性能低下，如果能做到对内提供内部的接口不走http协议，对外走一个公共的请求接口，如果你懂一点计算机网络的NAT模式，你就清楚我在说什么。根据《Go语言高级编程》第4章Protobuf与gRPC的内容，此处可改设计为rpc，这样调用就很方便，就像本地函数调用一样，所以还需要进一步分层。（计算机网络的基本原则，解决不了的问题就加一层试试）。

## 分层微服务架构

为了解决服务间的http通讯性能低下问题，改用grpc设计：

![电商分层微服务架构](/images/backendSystem/电商分层微服务架构.png)

web层结合了一系列逻辑，将各个接口整合，对外暴露出http接口的能力，srv层也可以相互调用。但是尽量分层后，srv层不要直接调用web层，这样不太合理。这样的架构带来了如下好处：服务之间的编程语言随便、组件随便不限制mysql。但是微服务架构听起来很美好，也伴随着一些问题，且这些解决方案都是为了解决因为微服务而产生的问题，你不接触微服务，就没必要考虑这些问题，尤其是在单体应用架构中。

## 滥用微服务架构

> 微服务的目的是将大型单一的应用拆分为多个可独立部署的小服务，既要按照业务划分，也应该按照后端人员数量划分。微服务的多少是粒度问题，这是业务与人员的平衡。但是很小的团队是不是也要按照这个思路去划分一大堆微服务出来呢？总的来说，业务、人员因素都需要考虑进去是不是值得用微服务。

在上面的分层微服务架构图中，只列举了4个服务，大型公司是成百上千的服务，这也是所有微服务都亟需解决的问题：

- 服务过多，如果服务间要相互调用，就需要知道目标服务的ip地址、端口号，这些组合成大量的信息
- 服务过多，怎么知道那些服务是健康的，怎么进行健康检查，人也是需要体检的，服务也需要涩

以上2个问题可以通过**注册中心**解决，每写完一个服务就将其ip/port注册到该模块中，该模块可以定期执行健康检查；同时还需要**服务发现**，当web层需要调用srv层时，先到服务发现模块去查询服务，该模块返回给web层查询到的srv层的目标服务的ip/port信息，然后该web层就可以通过这些信息对srv层的目标服务发起连接完成通讯。且当订单服务性能不够时，会想到另外一台服务器部署，把该服务变成集群服务，有了注册中心定期健康检查就能知道哪些是健康和不健康的。

同时，还需要**配置中心**，srv层的服务中的组件需要一些配置信息，例如mysql的端口、密码、超时时间等配置，这些服务特别多的时候，配置信息也呈爆炸性增长，这时候如果想要改配置信息，就必须要重新启动服务很麻烦，所以通过配置中心，srv层的服务每次启动都去配置中心读取配置，当需要修改配置信息，它会主动通知srv层的服务。

同时，还需要**链路追踪**，假设web层的订单服务调用了srv层的很多服务，调用链路很长，此时的下单接口很慢，要想分析排查原因，就需要链路追踪去记录调用时间分析排查问题。

最后，之前还提到一个对外的接口的问题需要解决，比如电商网站，需要访问web层的用户服务、商品服务，这些服务提供的ip/port可能是不一样的，所以如果让网站去记住这些信息明显不现实，所以需要通过**微服务网关**整合。

![完整的电商微服务](/images/backendSystem/完整的电商微服务.png)

# 短网址系统设计
